use itertools::Itertools;

static INPUT: &[u8] = b"###..#...#..##.######.###.##.#####.#.....###..##..####.##...##..##.#......##.###....#.##.##.##..#..#..#.#..#.#.#.###..##.##....###..#..#...#.#....##...#...###.###..#..#.####...#..##.#...#..####.#.#####.......#..###.#...#..###.#.######....#...#..#..##.....#.#...#.####.#####....####..#.##..#.#.#.#.#...#.#.##..##...#.#.#.##.##.#.####.#....#..#.##.#.##.###.#.###.###..#....#####.#..#.###.#####.#..#.#..#.#.##.#..#.###.##..##.#....##..#...#.#.####....#.##.#.#.......###..#...#..##.#####.#...####..#.##.###.###......";
static MAP: &str = ".######..##.#..#.#..#####..#.##..#.....####.#...#.##.#...#..##...#..###..#..#.######...##....#####.#\n.#.#....#.###..#.#.#.##..#.#......###...###....##.##.##...##.#.....#...#..#.#....###.#.##..##....###\n###..####.#...###...#.##.########.#..#####.#.#.#....#..######.#.##...#....#..######..######.#.#.##.#\n#.###.#.##..#.#...###..##..#.#..#....#..###..#.##...##...##..#.......##..##.##..##.#.#...##...##..##\n#.#....#.#.###..#....##.#.#...#..#.#.....####.#.##..#.#.##.....######.#...##...#..#.#.##..#...####..\n....#..##.##..##.######...##..#..###.#.#..#..####.#...###..##.#...##...####.#...##...#.#.###.#...#..\n..#.####.###...#..#..#####.##.#..##..##.#.#...#...#.#####..###...#.##.#..#..####....#....#.#.###..#.\n.##.#.#####.###..##.###.###.#..####...####.###...##.##.########.##.####.....###..#..##....##...#.###\n###.#.#.#.....#.#..##....#...####.#.#..#.###.######.##.###.##.#.##.#.##.#.#.#.#.##...###.####.#..#..\n#.#....###..#....#..####.......#.##..#.#..###......###.##..#....#.##....#.######.#.......##.#.#.#..#\n###.#######...#.#.....##...###...#...##.#..##.##..##..##.##......####.#.###.##..####..##....#..##.##\n..#.#...##..####..#.#..#.##....##......##.##..##.#.#.##...##....#..###.#####.#.#..##.##...##..####.#\n#.##..#.###.#.#.##.###..#..#..#.#..#...#.....#....##.....#..###.##.#.#...#....##..#..#..#..##..###.#\n#..#...##.#........#.....##.#..#.###########...#...###..#...#...#.#........#.#.#..#.....#.##.#...###\n...#.#.###...##..####..####.###...#.#..#.######.####....###.#.#...#..#.#....##...#....##.#.##.#..###\n.##....#.##.#.#.#...####.####......#.#.###..#..###..#.###.#...#...##...##...###.############..#..##.\n#..#.##...##.###########..####.#.###.....###.#....##.#.####..#..####.#.#...........#.#...###.###..##\n......##..#...######...######..#...##.#......#..##...#.....##.#####....#.#.#..####.#.##..#...#..##.#\n##.#..#########.....#.###.##.###..##.#.##.#..##.#..#...####..###.####...##......##.......###.###...#\n#.##.....#.##.#..#.#..#.##.##...#...######.##.#.###..##.#.#.#.###..##.##...###.#......###.#.#.....##\n...##.###..#.##......##.###.#.##.#....#####.#...###...###.##.#.##.#.#.#..#####..###..#.#........##.#\n....#.####.###...##.....#.#.#.....#.#..#.......#..##.#....#.##.####...#..##########...#.##...#.#####\n#.####..#...##.....#....##..###..###..###.#.#..#..##.#.#.#..#..#.#..#...#.#..#.#.....###....##.#.#..\n##.###.###...##..############..#..##.###..#..##..##..####.#########.####.##.###.#....#...##..#.##...\n###..#.##.#.#.###.##...##.##.#...#.#..###.###.########..#...###.##...#..#..##.....#.##..#..##..###..\n#.###..#...#.#####.##...#.##....########..#....#....##.##....#..##.#..#.#.##..##.#...#.##....##....#\n##.#..####....####.##...##....##..##.#......#..####..#...#..##.....#.#..##...##.#.##.#.###.##.####..\n#...#....#.###..###...##.#..#####..#.#..##.##.#..######..#.#.....##.#.########.##.##.##...#####.##..\n#.#.##...##...##.######.#####.#.#.#.###..####.#.#..##.....#.##.#..#.#.##..####.#...####.###.#.##.###\n###..##..####.#......#####.########.#.#.#.#..####.....#.##.#.###..###.###.##.##.##..##.##..#####..#.\n.#.#..##..#..#..##.##.####.#.##.##..####.##...#.###.#.#.###..#.....###..#..#.#.#.######...##.#.##.##\n#....##...####.#.#.####..##.##...#.####.#..#.#..#...####....#..#..#..####.....##..#..##.....##..####\n####.#.#...##.....##....#..###.###....####.#########...####..##########..#.###.#...#...#....#..#####\n#.##..###..#####...##.#.#..##.......#..####..#...##.#.#.#..###..##....#.##..##.#....#.##.#.###...#..\n####..#..####.##.....#####.##.#...#..#..#...#.....#.....##.#...#..#.###.........#..#....#####.##....\n..###.#.#...#.#..##..##.#.##.#..##.#..###.##....#.##.###....#..#.......####.#####..#...###.#..##...#\n.##.#.#...#..#.##....#...##......#.##.##.#..#####.#.#.#....#......#..#..#..####.#.#.##.##.###.##..#.\n##.###.##.####.#..##..####..#...#.##.###..#.######.#.##.###..##...##...#.#...##..###.##.#####..#...#\n.######..........#######.####..#.##.#..#.##...######..#...##...#.#####.#..#...#....####.#.######.###\n#....##.##.#.#....##..#.#.#...#.#..##.#...####....#.##...####...####....###......##.###...#........#\n#.#...##..##...#....##.....###.##...##.##.##.#####.######..#..##.###..#....##....#.####..#.###..##.#\n..####.###.####.###........#.#####.#.#...####..###.###.#####.####.##...###.#.#.####.#..#.##.###.#.##\n####.###.##.###...#######..##..#.##.##.#.#..#..#.#.###......#.#...#.##..#.##.#..###....#.#...##.#...\n.#.#.####.....#....####....###.#.##.#......#..#######.#..##.###..#.###..#....#......##.##....#.....#\n.#..###.....#.....##.#.##.##..###.....##.#.#.....#..#.#..#.##....##.#.###.#..###....#...#.##.###....\n.#.#.##.##...##...#.#.#.##..##..###...........######......##.###.#..####....#.##..###.#####......###\n#.##..#.##..#......##.#..######.#..###.##.#..##.####..#.###...#.#.#.##..###.#..#..###..#..###.##...#\n.###.#....#..#.#....######...#.##.#####.#.#....####...#..##...#.###....##.####..#....#.##...#.######\n#######.###..#..##.##...#.#....##.##...#.#..##.#.###.##..##...#..###..####.#......###......##.#.#...\n#...###.#.#..#.#....###..#.#####.#######.####......##.##.#.##....######..#######.##.#..#.###.#..####\n.#.#......##.#####.##.#...#..#.####.#.#...##..#####.#...#.###.#...#..##....##..#..##.#.##..#.#.###..\n..####..#.#..#..########.###......#.##....#..##.....#.##...#.##.....#........#...#.######...#######.\n#.##.#.######..#..####....##..##.##..#.##..#.##.###..#......###....###.#.###.........#.##.#...#.##.#\n...##.......###.#..#.#.#.##..#...#####.##...##.##...#.#....#..#....#....##.##....###...###.#######..\n#.....#######..#.#####....#...#..##.#.##...##.##.###..##..#.##..#..#...##..###...##.#....#...###..#.\n.#.####.#.#.....###..######..##.....#.##..#..####.######..##..##..#.#.###.#.#####...####..#.####.##.\n..#.##.#.#..#...#..####....#..##.##.##...#.##.#....#..#.#....#..##....#.#.#...###.#...#.##.##.##.#.#\n...###..##.#....#.#.........#...#..#.#....#.#.###.###..####.####.####..#####.##..#..#####.##..###.##\n#..#..#.#.#....#######.##..#.##..###..#####.#.#.........#.###..#..##..##.#...#.##.###..#.#..##.....#\n.#..#.#.#..###..###.###.##.#.#...##.#.#.#.#####.#.....##.#.#...###...##..####....#..####..#..#.#...#\n.#.#####...####.####...######...#.....##...#.####.##...#......#....######..##.###.....##....#.#.###.\n..#.###...##.###..#.##...####..###..#..##.......###.##.......##....#.#.###########..#..##.#.#...##..\n##..##.##..#....#.######.####..#....##.########..#...##.#...#.##.####..##..#####.#.#..#..#.##..#.#.#\n.#......#....#.###.##.##....##.....#.###..####.###.#.#...#.###....###..#.#.##.###..#####..#..#####..\n#..#.##.##.#...#..###.##..##.#..#.#.#########.#..#######.###..##.##...#..##.######.##.#..##.##...###\n##...#####..######.##..#..####......####.#.#....#..##...###.##....###...##.###.....#.....#...##...#.\n#.##.##..#.#.####.#.##.#.##.####........###.##.#.....##.###..#...#.##.##.#.##.##..#..######.#...##..\n##.##..#.##.#..#.#.#.###.#.#.######.#.#....#.#.##..##.#.###.#...#..#..#.#.#.##...#..####...##.#.#.##\n...#..##..###.#####.#.####.##.......#.#####...#.#....###..##..#.##.#.#.####.#####...##.#..##...#####\n.#.#.#.#.#.###.#.##..##.##......#####..###..#.#.#..##.#.##......##.####...#.#....##....###...###.###\n##...####...###.######.#.#.######..##...##.####.##..##.#.#.#.####...#.#.##.##...###.#.#.##.##.#.##..\n.#.#.###..##.##.#...##..#.##..#..###.##...#.#.#.#...##...###..###.#...###.#.#...######....#.##.##..#\n.##.#.##..#.#.######..#....#....#.#..###.##.#...###.##..##....###..#####.#.##.#...##...###..##..#.##\n..#....##...#...#.##.##...###.##..#...#..##....#....#.###.##.##.##.#.###....####.###.....#.##.#.##.#\n#..##.#####.....#.###..####.#..##..#.#.##..#####.#.##..#...#.##.######...##..#..####...####...#...#.\n##......##.#.###.##.#.###...##..##.#.#...##..##.##..#...##..###..#..#.###....##......###...#.#####..\n##...##....#..#..########.#..#.##.#.###.##....####.#.#.##..#.######.#...####..#....#####.##..#.#.#.#\n...#..#.#.##.#.#.#.....##.###.#.#.#######.####...####.#.#.#..##.#......#.....#.#.##..##...##.#.###..\n...#.##...#.#..#...#.##.#####.##.##.#.#####..##..####.#.####..##....#..####...###.###.###.#..##...#.\n#.####..#....##...#.#..###..#..#....#.#.###.#.#.##.##.#.########.#....##...####....#.##..###.##..##.\n####.#.###..##..#.#..#...###...#####.#.#..##..#.#....#.#........#..#....##.#....##.##.#..#..###..#..\n.##...##...#...####..###.######.#....#.##.####..#...###.....#..#.#.#..#.####.#.#...#..#..##..##..###\n###...#.###.....#....##..#..#.#####.#...#...###..#...#.#.#####..#.###...##.#.#.##.#.....##..#.##..#.\n####...##..#.#...###.#...##..#.#.######..##..####.###########..###.....#...######.......###.########\n##.##...##.#...####.#..###..####..##.....#...#..##.#.##..###........#.....###.##.####.#..##.#......#\n...#####.####.##...##.####..#####.#..#..#.#.#.#...#..#####.##.#.##.####..###.#.#...##....##.#.....#.\n##.#.##.....####.###.###..#..###...#.##..####.###..#.#..#.#..#.#..#...#.#.#####..#..#.#.#..#.#..#...\n#######..####..#.#######..#####.####....###..#####..#######.#.#.#.####.#..#.#....###.#..##.####.#...\n..##.#...#.#..#....###.#..###......#.#.#.#..##.#....##...#.....##......##.#...#.####...#.#.#.###.##.\n##..#.###..###.###..#.##.#.#.#..###..##.####.#.#.#.#.######.#..#.##..#...###.#.##.#####.###....###.#\n....###.###..##.#.####.#.###.......##.##.###.###.###...#...#.#.####.#.##..#.#...#..#.#.#.###.#.#.##.\n.#..#..####..#.###.##.#.##..#....#.#.###...###.#..###..#####.#.##.##..#.#...#..##....##.#...#..#.#.#\n###..#.####.#....#.#..###.#...#....#..#.#..#.#######.#.#.####..#..#.#.##.#....###.#..#.#.#####.#..##\n#.#.####.##.##..#....#.#.#.#..#.#####.###..##...##.#.#.##.###..#..#.#...##.#.#..##..#.###.#..###..#.\n#..#.##....##.#..#.##.##..####..#####..#.##.##...#..###.###.#.##.#..#..#.##.#...#...#.##...#..##..##\n..####..#.#...#..###..##.##...###..#.###......###..#..####.#####..#.#....##.#..##.###.#.....####..##\n#.##...#.#...####.####..##..#...#.#####.#...#..#.#.#.###.#..#..#..#####..#.#...#.####.#...#.####.##.\n.#.#.#.....##...###...##..###.##....##.#.#.##...####....##......##....#.##..#.#..###.##.###.#.......\n#....#.#.#..##.#####...##.#......#.####.#..##.####...##.###.###....#.......#.##..######..#.#.#####.#\n..#..###....##.#####..#.####.#.#####.#.##.....#..#.#..##..####.#.#.###..###.#.###.#...#.#..#...#.###";

fn num(map: &[Vec<u8>], (r,c): (usize,usize), val: u8) -> usize {
  let ns = [(r-1,c-1),(r-1,c),(r-1,c+1),(r,c-1),(r,c),(r,c+1),(r+1,c-1),(r+1,c),(r+1,c+1)];
  ns.iter().fold(0, |n, &(r,c)| {
    let x = *map.get(r).and_then(|row| row.get(c)).unwrap_or(&val) as usize;
    n << 1 | x
  })
}

fn enhance(map: &[Vec<u8>], val: u8) -> Vec<Vec<u8>> {
  let mut ans = vec![vec![0;map[0].len()+2];map.len()+2];
  for (r,c) in (0..ans.len()).cartesian_product(0..ans[0].len()) {
    ans[r][c] = (INPUT[num(map, (r-1,c-1), val)] == b'#') as u8;
  }
  ans
}

aoc2021::main! {
  let mut map = MAP.lines()
    .map(|l| l.chars().map(|c| (c == '#') as u8).collect())
    .collect::<Vec<_>>();
  for i in 0..2  { map = enhance(&map, i & 1) }
  let p1 = map.iter().flatten().filter(|&&b| b == 1).count();
  for i in 2..50 { map = enhance(&map, i & 1) }
  let p2 = map.iter().flatten().filter(|&&b| b == 1).count();
  (p1, p2)
}
