use itertools::Itertools;

static MAP: &[u8] = b"###..#...#..##.######.###.##.#####.#.....###..##..####.##...##..##.#......##.###....#.##.##.##..#..#..#.#..#.#.#.###..##.##....###..#..#...#.#....##...#...###.###..#..#.####...#..##.#...#..####.#.#####.......#..###.#...#..###.#.######....#...#..#..##.....#.#...#.####.#####....####..#.##..#.#.#.#.#...#.#.##..##...#.#.#.##.##.#.####.#....#..#.##.#.##.###.#.###.###..#....#####.#..#.###.#####.#..#.#..#.#.##.#..#.###.##..##.#....##..#...#.#.####....#.##.#.#.......###..#...#..##.#####.#...####..#.##.###.###......";
static INPUT: &str = ".######..##.#..#.#..#####..#.##..#.....####.#...#.##.#...#..##...#..###..#..#.######...##....#####.#\n.#.#....#.###..#.#.#.##..#.#......###...###....##.##.##...##.#.....#...#..#.#....###.#.##..##....###\n###..####.#...###...#.##.########.#..#####.#.#.#....#..######.#.##...#....#..######..######.#.#.##.#\n#.###.#.##..#.#...###..##..#.#..#....#..###..#.##...##...##..#.......##..##.##..##.#.#...##...##..##\n#.#....#.#.###..#....##.#.#...#..#.#.....####.#.##..#.#.##.....######.#...##...#..#.#.##..#...####..\n....#..##.##..##.######...##..#..###.#.#..#..####.#...###..##.#...##...####.#...##...#.#.###.#...#..\n..#.####.###...#..#..#####.##.#..##..##.#.#...#...#.#####..###...#.##.#..#..####....#....#.#.###..#.\n.##.#.#####.###..##.###.###.#..####...####.###...##.##.########.##.####.....###..#..##....##...#.###\n###.#.#.#.....#.#..##....#...####.#.#..#.###.######.##.###.##.#.##.#.##.#.#.#.#.##...###.####.#..#..\n#.#....###..#....#..####.......#.##..#.#..###......###.##..#....#.##....#.######.#.......##.#.#.#..#\n###.#######...#.#.....##...###...#...##.#..##.##..##..##.##......####.#.###.##..####..##....#..##.##\n..#.#...##..####..#.#..#.##....##......##.##..##.#.#.##...##....#..###.#####.#.#..##.##...##..####.#\n#.##..#.###.#.#.##.###..#..#..#.#..#...#.....#....##.....#..###.##.#.#...#....##..#..#..#..##..###.#\n#..#...##.#........#.....##.#..#.###########...#...###..#...#...#.#........#.#.#..#.....#.##.#...###\n...#.#.###...##..####..####.###...#.#..#.######.####....###.#.#...#..#.#....##...#....##.#.##.#..###\n.##....#.##.#.#.#...####.####......#.#.###..#..###..#.###.#...#...##...##...###.############..#..##.\n#..#.##...##.###########..####.#.###.....###.#....##.#.####..#..####.#.#...........#.#...###.###..##\n......##..#...######...######..#...##.#......#..##...#.....##.#####....#.#.#..####.#.##..#...#..##.#\n##.#..#########.....#.###.##.###..##.#.##.#..##.#..#...####..###.####...##......##.......###.###...#\n#.##.....#.##.#..#.#..#.##.##...#...######.##.#.###..##.#.#.#.###..##.##...###.#......###.#.#.....##\n...##.###..#.##......##.###.#.##.#....#####.#...###...###.##.#.##.#.#.#..#####..###..#.#........##.#\n....#.####.###...##.....#.#.#.....#.#..#.......#..##.#....#.##.####...#..##########...#.##...#.#####\n#.####..#...##.....#....##..###..###..###.#.#..#..##.#.#.#..#..#.#..#...#.#..#.#.....###....##.#.#..\n##.###.###...##..############..#..##.###..#..##..##..####.#########.####.##.###.#....#...##..#.##...\n###..#.##.#.#.###.##...##.##.#...#.#..###.###.########..#...###.##...#..#..##.....#.##..#..##..###..\n#.###..#...#.#####.##...#.##....########..#....#....##.##....#..##.#..#.#.##..##.#...#.##....##....#\n##.#..####....####.##...##....##..##.#......#..####..#...#..##.....#.#..##...##.#.##.#.###.##.####..\n#...#....#.###..###...##.#..#####..#.#..##.##.#..######..#.#.....##.#.########.##.##.##...#####.##..\n#.#.##...##...##.######.#####.#.#.#.###..####.#.#..##.....#.##.#..#.#.##..####.#...####.###.#.##.###\n###..##..####.#......#####.########.#.#.#.#..####.....#.##.#.###..###.###.##.##.##..##.##..#####..#.\n.#.#..##..#..#..##.##.####.#.##.##..####.##...#.###.#.#.###..#.....###..#..#.#.#.######...##.#.##.##\n#....##...####.#.#.####..##.##...#.####.#..#.#..#...####....#..#..#..####.....##..#..##.....##..####\n####.#.#...##.....##....#..###.###....####.#########...####..##########..#.###.#...#...#....#..#####\n#.##..###..#####...##.#.#..##.......#..####..#...##.#.#.#..###..##....#.##..##.#....#.##.#.###...#..\n####..#..####.##.....#####.##.#...#..#..#...#.....#.....##.#...#..#.###.........#..#....#####.##....\n..###.#.#...#.#..##..##.#.##.#..##.#..###.##....#.##.###....#..#.......####.#####..#...###.#..##...#\n.##.#.#...#..#.##....#...##......#.##.##.#..#####.#.#.#....#......#..#..#..####.#.#.##.##.###.##..#.\n##.###.##.####.#..##..####..#...#.##.###..#.######.#.##.###..##...##...#.#...##..###.##.#####..#...#\n.######..........#######.####..#.##.#..#.##...######..#...##...#.#####.#..#...#....####.#.######.###\n#....##.##.#.#....##..#.#.#...#.#..##.#...####....#.##...####...####....###......##.###...#........#\n#.#...##..##...#....##.....###.##...##.##.##.#####.######..#..##.###..#....##....#.####..#.###..##.#\n..####.###.####.###........#.#####.#.#...####..###.###.#####.####.##...###.#.#.####.#..#.##.###.#.##\n####.###.##.###...#######..##..#.##.##.#.#..#..#.#.###......#.#...#.##..#.##.#..###....#.#...##.#...\n.#.#.####.....#....####....###.#.##.#......#..#######.#..##.###..#.###..#....#......##.##....#.....#\n.#..###.....#.....##.#.##.##..###.....##.#.#.....#..#.#..#.##....##.#.###.#..###....#...#.##.###....\n.#.#.##.##...##...#.#.#.##..##..###...........######......##.###.#..####....#.##..###.#####......###\n#.##..#.##..#......##.#..######.#..###.##.#..##.####..#.###...#.#.#.##..###.#..#..###..#..###.##...#\n.###.#....#..#.#....######...#.##.#####.#.#....####...#..##...#.###....##.####..#....#.##...#.######\n#######.###..#..##.##...#.#....##.##...#.#..##.#.###.##..##...#..###..####.#......###......##.#.#...\n#...###.#.#..#.#....###..#.#####.#######.####......##.##.#.##....######..#######.##.#..#.###.#..####\n.#.#......##.#####.##.#...#..#.####.#.#...##..#####.#...#.###.#...#..##....##..#..##.#.##..#.#.###..\n..####..#.#..#..########.###......#.##....#..##.....#.##...#.##.....#........#...#.######...#######.\n#.##.#.######..#..####....##..##.##..#.##..#.##.###..#......###....###.#.###.........#.##.#...#.##.#\n...##.......###.#..#.#.#.##..#...#####.##...##.##...#.#....#..#....#....##.##....###...###.#######..\n#.....#######..#.#####....#...#..##.#.##...##.##.###..##..#.##..#..#...##..###...##.#....#...###..#.\n.#.####.#.#.....###..######..##.....#.##..#..####.######..##..##..#.#.###.#.#####...####..#.####.##.\n..#.##.#.#..#...#..####....#..##.##.##...#.##.#....#..#.#....#..##....#.#.#...###.#...#.##.##.##.#.#\n...###..##.#....#.#.........#...#..#.#....#.#.###.###..####.####.####..#####.##..#..#####.##..###.##\n#..#..#.#.#....#######.##..#.##..###..#####.#.#.........#.###..#..##..##.#...#.##.###..#.#..##.....#\n.#..#.#.#..###..###.###.##.#.#...##.#.#.#.#####.#.....##.#.#...###...##..####....#..####..#..#.#...#\n.#.#####...####.####...######...#.....##...#.####.##...#......#....######..##.###.....##....#.#.###.\n..#.###...##.###..#.##...####..###..#..##.......###.##.......##....#.#.###########..#..##.#.#...##..\n##..##.##..#....#.######.####..#....##.########..#...##.#...#.##.####..##..#####.#.#..#..#.##..#.#.#\n.#......#....#.###.##.##....##.....#.###..####.###.#.#...#.###....###..#.#.##.###..#####..#..#####..\n#..#.##.##.#...#..###.##..##.#..#.#.#########.#..#######.###..##.##...#..##.######.##.#..##.##...###\n##...#####..######.##..#..####......####.#.#....#..##...###.##....###...##.###.....#.....#...##...#.\n#.##.##..#.#.####.#.##.#.##.####........###.##.#.....##.###..#...#.##.##.#.##.##..#..######.#...##..\n##.##..#.##.#..#.#.#.###.#.#.######.#.#....#.#.##..##.#.###.#...#..#..#.#.#.##...#..####...##.#.#.##\n...#..##..###.#####.#.####.##.......#.#####...#.#....###..##..#.##.#.#.####.#####...##.#..##...#####\n.#.#.#.#.#.###.#.##..##.##......#####..###..#.#.#..##.#.##......##.####...#.#....##....###...###.###\n##...####...###.######.#.#.######..##...##.####.##..##.#.#.#.####...#.#.##.##...###.#.#.##.##.#.##..\n.#.#.###..##.##.#...##..#.##..#..###.##...#.#.#.#...##...###..###.#...###.#.#...######....#.##.##..#\n.##.#.##..#.#.######..#....#....#.#..###.##.#...###.##..##....###..#####.#.##.#...##...###..##..#.##\n..#....##...#...#.##.##...###.##..#...#..##....#....#.###.##.##.##.#.###....####.###.....#.##.#.##.#\n#..##.#####.....#.###..####.#..##..#.#.##..#####.#.##..#...#.##.######...##..#..####...####...#...#.\n##......##.#.###.##.#.###...##..##.#.#...##..##.##..#...##..###..#..#.###....##......###...#.#####..\n##...##....#..#..########.#..#.##.#.###.##....####.#.#.##..#.######.#...####..#....#####.##..#.#.#.#\n...#..#.#.##.#.#.#.....##.###.#.#.#######.####...####.#.#.#..##.#......#.....#.#.##..##...##.#.###..\n...#.##...#.#..#...#.##.#####.##.##.#.#####..##..####.#.####..##....#..####...###.###.###.#..##...#.\n#.####..#....##...#.#..###..#..#....#.#.###.#.#.##.##.#.########.#....##...####....#.##..###.##..##.\n####.#.###..##..#.#..#...###...#####.#.#..##..#.#....#.#........#..#....##.#....##.##.#..#..###..#..\n.##...##...#...####..###.######.#....#.##.####..#...###.....#..#.#.#..#.####.#.#...#..#..##..##..###\n###...#.###.....#....##..#..#.#####.#...#...###..#...#.#.#####..#.###...##.#.#.##.#.....##..#.##..#.\n####...##..#.#...###.#...##..#.#.######..##..####.###########..###.....#...######.......###.########\n##.##...##.#...####.#..###..####..##.....#...#..##.#.##..###........#.....###.##.####.#..##.#......#\n...#####.####.##...##.####..#####.#..#..#.#.#.#...#..#####.##.#.##.####..###.#.#...##....##.#.....#.\n##.#.##.....####.###.###..#..###...#.##..####.###..#.#..#.#..#.#..#...#.#.#####..#..#.#.#..#.#..#...\n#######..####..#.#######..#####.####....###..#####..#######.#.#.#.####.#..#.#....###.#..##.####.#...\n..##.#...#.#..#....###.#..###......#.#.#.#..##.#....##...#.....##......##.#...#.####...#.#.#.###.##.\n##..#.###..###.###..#.##.#.#.#..###..##.####.#.#.#.#.######.#..#.##..#...###.#.##.#####.###....###.#\n....###.###..##.#.####.#.###.......##.##.###.###.###...#...#.#.####.#.##..#.#...#..#.#.#.###.#.#.##.\n.#..#..####..#.###.##.#.##..#....#.#.###...###.#..###..#####.#.##.##..#.#...#..##....##.#...#..#.#.#\n###..#.####.#....#.#..###.#...#....#..#.#..#.#######.#.#.####..#..#.#.##.#....###.#..#.#.#####.#..##\n#.#.####.##.##..#....#.#.#.#..#.#####.###..##...##.#.#.##.###..#..#.#...##.#.#..##..#.###.#..###..#.\n#..#.##....##.#..#.##.##..####..#####..#.##.##...#..###.###.#.##.#..#..#.##.#...#...#.##...#..##..##\n..####..#.#...#..###..##.##...###..#.###......###..#..####.#####..#.#....##.#..##.###.#.....####..##\n#.##...#.#...####.####..##..#...#.#####.#...#..#.#.#.###.#..#..#..#####..#.#...#.####.#...#.####.##.\n.#.#.#.....##...###...##..###.##....##.#.#.##...####....##......##....#.##..#.#..###.##.###.#.......\n#....#.#.#..##.#####...##.#......#.####.#..##.####...##.###.###....#.......#.##..######..#.#.#####.#\n..#..###....##.#####..#.####.#.#####.#.##.....#..#.#..##..####.#.#.###..###.#.###.#...#.#..#...#.###";

fn updated_tile(grid: &[Vec<u8>], r: usize, c: usize, val: u8) -> u8 {
  let ns = [(r-1,c-1),(r-1,c),(r-1,c+1),(r,c-1),(r,c),(r,c+1),(r+1,c-1),(r+1,c),(r+1,c+1)];
  let i = ns.iter().fold(0, |n, &(r,c)| {
    let x = *grid.get(r).and_then(|row| row.get(c)).unwrap_or(&val) as usize;
    n << 1 | x
  });
  (MAP[i] == b'#') as u8
}

fn enhance(grid: &[Vec<u8>], val: u8) -> Vec<Vec<u8>> {
  let mut ans = vec![vec![0;grid[0].len()+2];grid.len()+2];
  for (r,c) in (0..ans.len()).cartesian_product(0..ans[0].len()) {
    ans[r][c] = updated_tile(grid, r-1, c-1, val);
  }
  ans
}

aoc2021::main! {
  let mut grid = INPUT.lines()
    .map(|l| l.chars().map(|c| (c == '#') as u8).collect())
    .collect::<Vec<_>>();
  for i in 0..2  { grid = enhance(&grid, i & 1) }
  let p1 = grid.iter().flatten().filter(|&&b| b == 1).count();
  for i in 2..50 { grid = enhance(&grid, i & 1) }
  let p2 = grid.iter().flatten().filter(|&&b| b == 1).count();
  (p1, p2)
}
